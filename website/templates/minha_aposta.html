{% extends "base.html" %}
{% block title %}
Minha Aposta
{% endblock %}
{% block content %}
<style>
    body {
        background-image: url('/static/imagens/maraca.jpeg'); /* Imagem de fundo */
        background-size: cover; 
        background-position: center;
        background-attachment: fixed;
        background-repeat: no-repeat; /* Impede a repetição da imagem */
    }
    .aposta-container {
        background-color: rgba(255, 255, 255, 0.8); /* Adiciona um fundo branco transparente ao formulário */
        border-radius: 10px;
        padding: auto;
        margin-top: 50px; /* Ajusta o espaçamento superior */
        max-width: auto; /* Define a largura máxima do contêiner */
        margin-left: auto; /* Centraliza horizontalmente */
        margin-right: auto; /* Centraliza horizontalmente */
        text-align: center; /* Centraliza o conteúdo */
    }
    .aposta-container button {
        padding: 10px 20px; /* Adiciona preenchimento ao botão */
        background-color: #006300; /* Cor de fundo do botão */
        color: #fff; /* Cor do texto do botão */
        border: none; /* Remove a borda */
        border-radius: 5px; /* Adiciona bordas arredondadas */
        cursor: pointer; /* Muda o cursor ao passar por cima */
        transition: background-color 0.3s ease; /* Adiciona transição suave para a mudança de cor de fundo */
        font-weight: bold;
    }
    .aposta-container button:hover {
        background-color: #034b03; /* Altera a cor de fundo quando o cursor está sobre o botão */
    }
    .button-container {
        display: flex;
        justify-content: center;
        margin-top: 20px;
    }
    .button-container button {
        margin: 0 10px; /* Adiciona espaçamento horizontal entre os botões */
    }
</style>
<div class="container mt-4 aposta-container">
    <h1 class="text-center">Aposta</h1>
    <div class="row justify-content-center">
        <div class="col-lg-8">
            {% if not has_aposta %}
                <h2 class="text-center">
                    {% if not dias_restantes.days == 0 %}
                        Restam {{ dias_restantes.days }} dias para apostar!
                    {% else %}
                        Último dia para poder apostar!
                    {% endif %}
                </h2>
                <div class="button-container">
                    <button type="submit" id="salvar_aposta" class="btn btn-success" {% if prazo_limite %}disabled{% endif %}>Salvar aposta</button>
                    <button type="submit" id="aposta_aleatoria" class="btn btn-warning">Estou com sorte</button>
                </div>
                {% if prazo_limite %}
                    <p class="font-weight-bold text-center mt-3">Acabou o tempo de apostas. Tente novamente no próximo ano.</p>
                {% endif %}
                <ol id="todoList" class="list-group mt-4">
                    {% for time in times %}
                        <li class="list-group-item list-group-item-action d-flex" draggable="true">
                            <span class="list-item-number d-flex"></span>
                            <img src="{{ time.img_url }}" class="rounded mx-2" width="25" height="25" draggable="false"/>
                            {{ time.nome }}
                        </li>
                    {% endfor %}
                </ol>
            {% else %}
                <h2 class="text-center">Data de aposta: {{ current_aposta.data_confirmacao }}</h2>
                <ol id="aposta_feita" class="list-group mt-4">
                    {% for time in formatted_aposta %}
                        <li class="list-group-item list-group-item-action d-flex" draggable="false">
                            <span class="list-item-number d-flex"></span>
                            <img src="{{ time.img_url }}" class="rounded mx-2" width="25" height="25"/>
                            {{ time.nome }}
                        </li>
                    {% endfor %}
                </ol>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block javascript %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
    const todoList = document.getElementById('todoList');
    const apostaFeita = document.getElementById('aposta_feita');
    const getRandomButton = document.getElementById('aposta_aleatoria');
    const saveGuessButton = document.getElementById('salvar_aposta');

    let draggedItem = null;
    updateItemNumbers()
    // Update item numbers
    function updateItemNumbers() {
      const items = todoList?.querySelectorAll('.list-group-item');
      const itemsFeito = apostaFeita?.querySelectorAll('.list-group-item');
      
      items?.forEach((item, index) => {
        const numberSpan = item.querySelector('.list-item-number');
        if (numberSpan) {
          numberSpan.textContent = (index + 1) + '.';
        }
      });
      itemsFeito?.forEach((item, index) => {
        const numberSpan = item.querySelector('.list-item-number');
        if (numberSpan) {
          numberSpan.textContent = (index + 1) + '.';
        }
      });
    }

    function handleSaveGuess(guessJson) {
      // Chamar o Python
      fetch("/salvar_aposta", {
        method: "POST",
        body: JSON.stringify(guessJson),
      }).then((_res) => {
        window.location.href = "/minha_aposta";
      });
    }

    // Function to shuffle array
    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    // Shuffle button click event
    getRandomButton.addEventListener('click', function() {
      const items = Array.from(todoList.children);
      shuffleArray(items);
      items.forEach(item => todoList.appendChild(item));
      updateItemNumbers();
    });

    // Save guess click event
    saveGuessButton.addEventListener('click', function() {
      if(!confirm('Após salvar, a aposta não poderá ser editada.\n Confirma salvar a aposta?')) { return; }
      const items = Array.from(todoList.children);
      const guessJson = [];
      items.forEach(item => {
        let formattedRow = item.innerText.split('.\n');
        guessJson.push({id: formattedRow[0], nome: formattedRow[1]});
      });
      handleSaveGuess(guessJson);
    });

    // Add event listeners to draggable items for both mouse and touch events
    todoList.addEventListener('dragstart', function(event) {
      draggedItem = event.target;
      event.dataTransfer.setData('text/plain', ''); // for Firefox support
      setTimeout(() => {
        event.target.style.display = 'none';
      }, 0);
    });

    todoList.addEventListener('dragover', function(event) {
      event.preventDefault();
      const afterElement = getDragAfterElement(todoList, event.clientY);
      if (afterElement == null) {
        todoList.appendChild(draggedItem);
      } else {
        todoList.insertBefore(draggedItem, afterElement);
      }
      updateItemNumbers();
    });

    todoList.addEventListener('dragend', function() {
      setTimeout(() => {
        draggedItem.style.display = 'block';
        draggedItem = null;
      }, 0);
    });

    // Touch events
    let touchY;

    todoList.addEventListener('touchstart', function(event) {
      draggedItem = event.target;
      touchY = event.touches[0].clientY// - draggedItem.getBoundingClientRect().top;
      event.target.style.opacity = '0.5';
      event.target.style.zIndex = '1000'; // Set z-index to make it appear above other items
    });

    todoList.addEventListener('touchmove', function(event) {
      event.preventDefault();
      if (draggedItem) {
        const newPosition = event.touches[0].clientY // - touchY;//- todoList.getBoundingClientRect().top
        //draggedItem.style.top = newPosition + 'px';

        const afterElement = getDragAfterElement(todoList, newPosition);
        if (afterElement == null) {
            todoList.appendChild(draggedItem);
        } else {
            todoList.insertBefore(draggedItem, afterElement);
        }
      }
    });

    todoList.addEventListener('touchend', function(event) {
      event.target.style.opacity = '1';
      if (draggedItem) {
        draggedItem.style.top = '';
        draggedItem.style.zIndex = ''; // Reset z-index
        draggedItem = null;
      }
      updateItemNumbers();
    });

    function getDragAfterElement(container, y) {
      const draggableElements = [...container.querySelectorAll('.list-group-item:not(.dragging)')];

      return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) {
          return { offset: offset, element: child };
        } else {
          return closest;
        }
      }, { offset: Number.NEGATIVE_INFINITY }).element;
    }
  });
</script>
{% endblock %}